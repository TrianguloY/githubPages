<!DOCTYPE html>
<html>
	<head>
		<title>Checker Board</title>

		<script>

//var lados = "ulrd,lru,lru,lur,lur,lur,lur,lur,lur,lurd;"+
//			"udlr,lr,lr,lr,lr,lr,lr,lr,lr,udrl;"+
//			"uldr,ldr,ldr,ldr,ldr,ldr,ldr,ldr,ldr,udrl";
//
//		
//var dataEnemigos = "4,1;5,1";
//
//
//var end = [8,1];
//var inicial = [1,1];

//var lados = "ulrd,ulrd,ulr  ,ulr,ulr,ulr,ulr,ulr,ulr;"+
//			"uld ,udr ,ld  ,rd,lrd,lrd,lrd,lrd,ld;"+
//            "uld ,udr ,udrl,ulr,ulr,ulr,ulr,udrl,uld;"+
//			"uld ,ur  ,ul,dr,lr,lr,ld,urd,uld;"+
//			"uld ,dr  ,ld,ud,rd,ld,ud,udr,udl;"+
//			"uld ,udr ,udl,ud,udr,udl,ud,udr,udl;"+
//			"uld ,udr ,udrl,ulr,url,url,ul,udr,ul;"+
//			"uld ,urd ,uld,rd,rld,rld,rld,udrl,ld;"+
//			"uld ,ur  ,ulr,ulr,ulr,ulr,ulr,ulr,ul"
//			;//"ur,lr,ld;d,d,ud;ur,url,ul";
//		
//var dataEnemigos = "2,1;2,2;2,3;1,3;1,2;1,1-"+ 
//			"3,1;4,1;5,1;6,1;7,1;8,1;8,2;7,2;6,2;5,2;4,2;3,2-"+ 
//			"8,6;7,6;7,5;7,4;7,3;7,2;7,1;8,1;8,2;8,3;8,4;8,5-"+ 
//			"7,7;6,7;5,7;4,7;3,7;3,8;4,8;5,8;6,8;7,8;8,8;8,7-"+ 
//			"1,4;2,4;2,5;2,6;2,7;2,8;1,8;1,7;1,6;1,5-"+ 
//			"5,3;4,3;3,3;3,4;3,5;3,6;4,6;5,6;6,6;6,5;6,4;6,3" 
//			//"1,1;2,1;3,1;2,1-3,3;2,3;1,3;2,3";
//
//			
//			
//var end = [1,0];
//var inicial = [4,4];

var lados = "dr,udr,udr,udr,ur,dr,ud,ur,r;rl,drl,udrl,udrl,url,rl,,rl,rl;rl,drl,udrl,udrl,url,dlr,ud,ul,rl;rl,drl,udrl,udrl,url,drl,u,dr,url;rl,drl,udrl,udrl,url,l,r,dl,url;rl,drl,udrl,udrl,udrl,ur,dl,ur,rl;rl,drl,udrl,udl,udl,udl,ud,ul,rl;rl,dl,udl,ud,ud,ud,u,dr,url;dl,ud,ud,ud,ud,ud,u,l,l";

var dataEnemigos = "X2,0;3,0;4,0;5,0;4,0;3,0-"+
				   "Y1,1;0,1;0,2;0,3;0,4;1,4;1,3;1,2-"+
				   "Y3,2;4,2;4,3;3,3;2,3;2,2-"+
				   "Y5,5;6,5;6,4;6,3;6,2;6,1;5,1;5,2;5,3;5,4-"+
				   "X8,2;8,3;8,4;8,5;8,4;8,3;8,2;8,1-"+
				   "X2,6;2,5;1,5;0,5;0,6;0,7;1,7;2,7-"+
				   "X5,8;6,8;7,8;8,8;7,8;6,8";

/*
"X6,4;5,4;4,4;3,4;3,3;3<!-- ,2;3,1;4,1;5,1;6,1;6,2;6,3-"+
					"4,5;5,5;4,5;3,5;2,5;1,5;2,5;3,5-"+
					"1,6;2,6;3,6;4,6;5,6;4,6;3,6;2,6-"+
					"3,7;4,7;5,7;4,7;3,7;2,7;1,7;2,7-"+
					"3,8;2,8;1,8;2,8;3,8;4,8;5,8;4,8-"+
					"3,9;4,9;5,9;5,10;5,11;5,12;4,12;3,12;2,12;1,12;1,11;1,10;1,9;2,9-"+
					"3,12;2,12;1,12;1,11;1,10;1,9;2,9;3,9;4,9;5,9;5,10;5,11;5,12;4,12-"+
					"6,12;6,11;6,10;6,9;6,8;6,9;6,10;6,11-"+
					"7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10-"+
					"9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8-"+
					"9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6-"+
					"8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4-"+
					"9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1-"+
					"12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1-"+
					"15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1-"+
					"15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3-"+
					"15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6-"+
					"15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9-"+
					"14,12;13,12;12,12;11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12-"+
					"11,12;10,12;9,12;8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12-"+
					"8,12;7,12;7,11;7,10;7,9;7,8;8,8;9,8;9,7;9,6;9,5;9,4;8,4;8,3;8,2;8,1;9,1;10,1;11,1;12,1;13,1;14,1;15,1;15,2;15,3;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,12;14,12;13,12;12,12;11,12;10,12;9,12-"+
					"8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9-"+
					"10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11-"+
					"14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11-"+
					"14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8-"+
					"14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4-"+
					"11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2-"+
					"10,3;10,4;10,5;10,6;10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3-"+
					"10,7;10,8;10,9;9,9;8,9;8,10;8,11;9,11;10,11;11,11;12,11;13,11;14,11;14,10;14,9;14,8;14,7;14,6;14,5;14,4;14,3;14,2;13,2;12,2;11,2;10,2;9,2;9,3;10,3;10,4;10,5;10,6";
*/



var end = [7,6];
var inicialP = [0,8];
var inicialL = [1,8];

var botones = [ [8,7], [3,6], [8,0] ];
var puertas = [ [1,7], [8,6], [4,5] ];
	
var ancho = 50;
var alto = 50;	
var canvas;
var context2D;
var matrix;
var sizeX;
var sizeY;
var enemigos;
var caminos;
var tipos;
var alive;

var playerP;
var playerL;

var active;

		
function initialize(){


//matrix=[];

//var filas = lados.split(";");
//sizeY=filas.length;
//
//sizeX=filas[0].split(",").length;
//
//
//for(var i=0;i<sizeX;++i){
//	matrix[i]=[];
//	var columnas=filas[i].split(",");
//	sizeX = columnas.length;
//	for(var j=0;j<sizeX;++j){
//		var elemento=columnas[j];
//		matrix[i][j]=elemento;
//		
//		if( i>0 && (elemento.indexOf("u")==-1)!=(matrix[i-1][j].indexOf("d")==-1) ){
//		alert("error ud "+j+" "+i);
//		return
//		}
//		
//		if( j>0 && (elemento.indexOf("l")==-1)!=(matrix[i][j-1].indexOf("r")==-1) ){
//		alert("error rl "+j+" "+i);
//		return
//		}
//		
//	}
//}


matrix = lados.split(";").map(function(v){return v.split(",")});
sizeX = matrix.length;
sizeY = matrix[0].length;

caminos=[];
enemigos=[];
tipos=[];

if(dataEnemigos.length>0){

	var en=dataEnemigos.split("-");
	for(var i=0;i<en.length;++i){
	var enemy = en[i];
	caminos[i]=enemy.substr(1).split(";").map(function(v){return v.split(",").map(function(v){return parseInt(v)})});

	enemigos[i]=0
	tipos[i]=enemy[0];
	}
}




//draw matrix
canvas = document.getElementById("background");
context2D = canvas.getContext("2d");

canvas.height = alto*sizeX;
canvas.width = ancho*sizeY;

document.getElementById("canvas").setAttribute("style","width:"+canvas.width+"px;height:"+canvas.height+"px");




context2D.beginPath();
context2D.lineWidth="5";
context2D.strokeStyle="black";

for(var i=0;i<matrix.length;++i){
var columnas=matrix[i];
for(var j=0;j<columnas.length;++j){
var elemento=columnas[j];
if(elemento.indexOf("l")==-1){
context2D.moveTo(i*ancho,j*alto);
context2D.lineTo(i*ancho,(j+1)*alto);
context2D.stroke();
}
if(elemento.indexOf("r")==-1){
context2D.moveTo((i+1)*ancho,j*alto);
context2D.lineTo((i+1)*ancho,(j+1)*alto);
context2D.stroke();
}
if(elemento.indexOf("u")==-1){
context2D.moveTo(i*ancho,j*alto);
context2D.lineTo((i+1)*ancho,j*alto);
context2D.stroke();
}
if(elemento.indexOf("d")==-1){
context2D.moveTo(i*ancho,(j+1)*alto);
context2D.lineTo((i+1)*ancho,(j+1)*alto);
context2D.stroke();
}

if(elemento.length==0){
drawSquare([i,j],'black',1);
}
}
}

//draw destiny
drawSquare(end,"#FFFF00");
drawLetter(end,"O");

//draw buttons
for(var i=0;i<botones.length;i+=1){
	drawSquare(botones[i],"#9999FF");
	drawLetter(botones[i],i+1);
	drawDoorLetter(puertas[i],i+1);
}


//set other layer
canvas = document.getElementById("players");
context2D = canvas.getContext("2d");

canvas.height=alto*sizeX;
canvas.width=ancho*sizeY;


//initialize the other layer
reset();

}

function reset(){

playerP = [inicialP[0],inicialP[1]];
playerL = [inicialL[0],inicialL[1]];

active = "P";

for(var i=0;i<enemigos.length;++i){
enemigos[i]=0;
}

alive=true;

refresh();

}

function refresh(){

context2D.clearRect(0, 0, canvas.width, canvas.height);





//draw player
drawLetter(playerP,"P",active=="P");
drawLetter(playerL,"L",active=="L");



//draw enemigos
for(var i=0;i<enemigos.length;++i){
var c=caminos[i];

var pos=c[enemigos[i]];


drawEnemyVision(pos[0],pos[1],tipos[i]);


var pos1=c[(enemigos[i]+1)%c.length];
drawEnemyVision(pos1[0],pos1[1],tipos[i]);

var dir = [pos1[0]-pos[0],pos1[1]-pos[1]];
var dirletra = dir[0]==1?"r":dir[0]==-1?"l":dir[1]==1?"d":dir[1]==-1?"u":"error";
if(dirletra=="error"){
alert("error al dibujar enemigos");
return;
}



if(matrix[pos1[0]][pos1[1]].indexOf(dirletra)!=-1){

var pos2=[pos1[0]+dir[0],pos1[1]+dir[1]];
drawEnemyVision(pos2[0],pos2[1],tipos[i]);
}

drawLetter(pos,tipos[i])

}


//draw doors
for(var i=0;i<botones.length;i+=1){
	var bot = botones[i];
	var color;
	if( same(bot,playerP) || same(bot,playerL)){
		matrix[puertas[i][0]][puertas[i][1]] = matrix[puertas[i][0]][puertas[i][1]]+"d";
		matrix[puertas[i][0]][puertas[i][1]+1] = matrix[puertas[i][0]][puertas[i][1]+1]+"u";
		color = "white";
	}else{
		matrix[puertas[i][0]][puertas[i][1]] = matrix[puertas[i][0]][puertas[i][1]].replace(/d/g,"");
		matrix[puertas[i][0]][puertas[i][1]+1] = matrix[puertas[i][0]][puertas[i][1]+1].replace(/u/g,"");
		color = "black";
	}
	
	context2D.beginPath();
	context2D.lineWidth="5";
	context2D.strokeStyle=color;
	context2D.moveTo((puertas[i][0]  )*ancho,(puertas[i][1]+1)*alto);
	context2D.lineTo((puertas[i][0]+1)*ancho,(puertas[i][1]+1)*alto);
	context2D.stroke();
}


}


function drawEnemyVision(x,y,tipo){

drawSquare([x,y],tipo=="X"?"#FF0000":"#990000");


var pillado = "";

if(x==playerP[0] && y==playerP[1]) pillado = "Paravicini";
if(x==playerL[0] && y==playerL[1] && tipo=="Y") pillado += (pillado!=""?" y a " : "") + "Lupin";

if(pillado!=""){
alert("Oh no! han pillado a "+pillado+", intentalo otra vez");
alive=false;
}
}



function movePlayer(d){
if(!alive) return;

var player = active == "L" ? playerL : playerP;

	if(matrix[player[0]][player[1]].indexOf(d)!=-1){
		if(d=="u"){
			if(player[1]<=0) return;
			player[1]--;
		}else if(d=="d"){
			if(player[1]>=sizeX-1) return;
			player[1]++;
		}else if(d=="r"){
			if(player[0]>=sizeY-1) return;
			player[0]++;
		}else if(d=="l"){
			if(player[0]<=0) return;
			player[0]--;
		}
		
		updateEnemys();
		
		refresh();
		
		if(playerP[0]==end[0] && playerP[1]==end[1] && playerL[0]==end[0] && playerL[1]==end[1]){
		//sí, ésta es la frase, pero ¿no es más divertido resolver el acertijo de forma normal en lugar de mirar el código fuente? 
		//(no, tienes razón, es más divertido con el código fuente. Aun así dale una oportunidad, anda... :P )
		alert('¡Enhorabuena! Lo has conseguido. Envíale a Jorge la frase:\n"El dúo dinámico ataca de nuevo!"');
		alive=false;
		}
	}
}
		
		
		
		
function updateEnemys(){

for(var i=0;i<enemigos.length;++i){
enemigos[i]=(enemigos[i]+1)%caminos[i].length;
}

}


function drawSquare(pos,color,alpha=0.2){
	var l=context2D.lineWidth/2;

	context2D.globalAlpha=alpha;
	context2D.fillStyle=color;

	context2D.fillRect(pos[0]*ancho+l,pos[1]*alto+l,ancho-l-l,alto-l-l);

}

function drawLetter(pos,letter,inactive){

	context2D.font="30px Arial";
	context2D.textAlign="center";
	context2D.textBaseline="middle";
	context2D.fillStyle= inactive==false? "grey" : "black";
	context2D.globalAlpha=1;
	context2D.fillText(letter,(pos[0]+0.5)*ancho,(pos[1]+0.5)*alto,ancho);

}


function drawDoorLetter(pos,n){//horizontal door, pos of cell above it
	
	context2D.font="10px Arial";
	context2D.textAlign="center";
	context2D.textBaseline="bottom";
	context2D.fillStyle="black";
	context2D.globalAlpha=1;
	context2D.fillText(n+"",(pos[0]+0.5)*ancho,(pos[1]+0.975)*alto,ancho);

}


document.onkeydown = function(e){

	if ( !e.metaKey ) {
		e.preventDefault();
	}

    e = e || window.event;
	
	return checkKey(e.keyCode);

};

function checkKey(code) {
	

    if (code == '38') {
        movePlayer("u");
    }
    else if (code == '40') {
        movePlayer("d");
    }
    else if (code == '37') {
       movePlayer("l");
    }
    else if (code == '39') {
       movePlayer("r");
    }
	else if(code == '27') {
		reset();
	}else if(code == '80'){//p
		active = "P";
		refresh();
	}else if(code == '76'){//l
		active = "L";
		refresh();
	}else if(code == '32'){//space
		active = active=="P" ? "L" : "P";
		refresh();
	}else{
		return true;
	}
		
	
	
	
	return false;
}





function same(a,b){
return a[0]==b[0] && a[1]==b[1];
}

		</script>
		<style>
		.cuarto{
		width:150px;
		height:150px;
		}
		.medio{
		width:300px;
		height:70px;
		}
		</style>
	</head>

	<body onload="initialize();">
		<div id="canvas" style="position:relative;height:500px;width:500px">
		 <canvas id="background" width="500" height="500" 
		   style="position: absolute; left: 0px; top: 0px; z-index: 0;"></canvas>
		 <canvas id="players" width="500" height="500" 
		   style="position: absolute; left: 0px; top: 0px; z-index: 1;"></canvas>
		</div>
		<br>
		<button class="cuarto" type="button" onclick="checkKey(37)"><</button>
		<button class="cuarto" type="button" onclick="checkKey(38)">/\</button>
		<button class="cuarto" type="button" onclick="checkKey(40)">\/</button>
		<button class="cuarto" type="button" onclick="checkKey(39)">></button>
		<br>
		<button class="medio" type="button" onclick="checkKey(32)">P<->L (Space)</button>
		<button class="medio" type="button" onclick="checkKey(27)">Reset (Esc)</button>
	</body>
</html>